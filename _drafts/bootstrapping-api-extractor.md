---
title: Bootstrapping API Extractor
tags: frontend
---

wise words

```
npm install -D @microsoft/api-extractor

added 30 packages, removed 6 packages, and audited 1015 packages in 5s
```

```
% npx api-extractor init

api-extractor 7.47.0  - https://api-extractor.com/

Writing file: /Users/tim/GitHub/infinisheet/api-extractor.json

The recommended location for this file is in the project's "config" subfolder,
or else in the top-level folder with package.json.
```

Config file produced includes full reference documentation for each option as comments. It's huge. Pages and pages of it. It's allow a sea of red squiggly lines in VS Code because JSON files don't support comments. Except you see JSON files with comments all the time. For example, `tsconfig.json`. 

Rabbit hole time. Internally VS Code supports two parsers for JSON. A standard compliant one for the "json" format, and another one for "jsonc" which does support comments. You can setup file associations that map file patterns to the parser to use. By default `tsconfig.json` and `tsconfig.*.json` are mapped to "jsonc". Makes sense. TypeScript is a Microsoft product. Apparently, some third party config file formats also have default rules that map them to "jsonc". However, for some reason "api-extractor.json" gets no special treatment and you have to setup a file association yourself. 

Edited config file to set the mandatory `mainEntryPointFilePath` property to point at the `dist/index.d.ts` file generated by my Rollup build. Disabled API Extractor from trying to generate its own rollup of my rollup.

```
% npx api-extractor run --local --verbose

api-extractor 7.47.0  - https://api-extractor.com/

Using configuration from ./api-extractor.json
Analysis will use the bundled TypeScript version 5.4.2
*** The target project appears to use TypeScript 5.5.2 which is newer than the bundled compiler engine; consider upgrading API Extractor.
Writing: /Users/tim/GitHub/infinisheet/packages/react-virtual-scroll/temp/react-virtual-scroll.api.json
Generating complete API report: /Users/tim/GitHub/infinisheet/packages/react-virtual-scroll/etc/react-virtual-scroll.api.md
Error: Unable to create the API report file. Please make sure the target folder exists:
/Users/tim/GitHub/infinisheet/packages/react-virtual-scroll/etc
Warning: dist/index.d.ts:55:1 - (ae-missing-release-tag) "VirtualInnerProps" is part of the package's API, but it is missing a release tag (@alpha, @beta, @public, or @internal)
Warning: dist/index.d.ts:55:1 - (ae-unresolved-link) The @link reference could not be resolved: The package "@candidstartup/react-virtual-scroll" does not have an export "VirtualInnerComponent"
...
```

* Worrying message about TypeScript versions. I've just installed the latest version of API Extractor. Digging deeper [suggests](https://github.com/microsoft/rushstack/issues/4404) that this is a common state of affairs and generally nothing to worry about. API Extractor only needs uses the TypeScript compiler to read the `*.d.ts` file which is much simpler and less likely to have significant changes from version to version.
* I changed the config so that the API report goes into the project folder rather than `./etc`. 
* That just leaves the long list of errors. Despite being described as warnings, the [documentation](https://api-extractor.com/pages/setup/configure_api_report/) says they result in a nonzero exit code which would cause production builds to fail. You can configure things so that selected warnings go into the API report instead. 
* Looking at the generated `react-virtual-scroll.api.md` there are lots more warnings there. 

```ts
// Warning: (ae-forgotten-export) The symbol "FixedSizeItemOffsetMapping" needs to be exported by the entry point index.d.ts
//
// @public (undocumented)
export function useFixedSizeItemOffsetMapping(itemSize: number): FixedSizeItemOffsetMapping;
```

* I had subconsciously been following a policy of explicitly exporting the top level symbols that a user would directly import but not dependent symbols. Up to this point everything has worked. Api Extractor is suggesting that every dependency needs to be explicitly exported. 
* Works for simple cases. IntelliSense help not limited by rules of type system. Compiler can infer types in some cases. You can use value of a property of unexported type. 
* Won't work if user writes code that accesses type explicitly. For example, extending it. Or declaring a variable of that type. 
* Correct thing is to export everything visible.
* Went through and made sure everything referenced by public API is explicitly exported.
* Lots of common stuff in `VirtualBase.ts`. All of it needs exporting apart from one bit of common implementation used by `VirtualList.tsx` and `VirtualGrid.tsx`
* Moved the implementation into `VirtualCommon.ts` so I can safely export `VirtualBase` as a whole
* For now don't want to bother with explicitly adding release tags to everything in the API so have disabled that warning.

```js
  "messages": {
    "extractorMessageReporting": {
      "ae-missing-release-tag": {
        "logLevel": "none"
      }
    }
  }
```

That left me with two remaining errors

```
Warning: dist/index.d.ts:50:5 - (ae-unresolved-link) The @link reference could not be resolved: No member was found with name "maxCssSize"
Warning: dist/index.d.ts:185:5 - (ae-unresolved-link) The @link reference could not be resolved: No member was found with name "data"
```

Both of these are real problems caused by typos in my TSDoc comments. 

* Now fixed all the warnings in console and API report
* Left with one intriguing comment at the bottom of the report: `// (No @packageDocumentation comment for this package)`
* Comment with [this tag](https://api-extractor.com/pages/tsdoc/tag_packagedocumentation/) is used by the API documentation generator to describe the package as a whole.
* Needs to be first comment in `index.d.ts`. Easy, add it at the top of `index.ts`.
* The comment gets copied into `index.d.ts` by the TypeScript compiler. 
* Rollup helpfully removes the comment when generating my rolled up `index.d.ts` because it doesn't apply to anything.
* Tried hack of defining a dummy exported type for comment to apply to. Comment makes it into rolled up file but API Extractor still complains because comment needs to be literally the first thing in the file. 
* Will need to rework my build pipeline so that API Extractor runs on output of tsc before Rollup generates final bundle
* Could use API Extractor to produce bundled `index.d.ts` rather than Rollup dts plugin
* Before doing that, let's look at API Documenter and see if it's worth doing
